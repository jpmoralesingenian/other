<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>dc.js example - Untappd Data Visualization</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="css/dc.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
</head>
<body>
<div class="container-fluid">
	<div class="row">
		<div class="col-xs-12 dc-data-count dc-chart" id="data-count">
		<h2>Ventas
			<small>
				<span class="filter-count"></span> propuestas seleccionadas de <span class="total-count"></span> | 
					<a id="all" href="#">Limpiar todo</a>
				</span>
			</small>
		</h2>
		</div>
		<div class="col-xs-12 dc-data-count dc-chart" id="money-count">
		</div>
	</div>
	<div class="row" id="filter-row">
		<div class="2u chart-wrapper" id="filter-year">
			<div class="chart-title"> <strong> Año </strong></div>
		</div>
		<div class="2u chart-wrapper" id="filter-quarter">
			<div class="chart-title"> <strong> Trimestre </strong></div>
		</div>
		<div class="2u chart-wrapper" id="filter-month">
			<div class="chart-title"> <strong> Mes </strong></div>
		</div>
		<div class="2u chart-wrapper" id="filter-stage">
			<div class="chart-title"> <strong> Estado</strong></div>
		</div>
		<div class="2u chart-wrapper" id="filter-person">
			<div class="chart-title"> <strong> Encargado</strong></div>
		</div>
	</div>
	<div class="row" id="filter-row2">
		<div class="6u chart-wrapper" id="filter-customer">
			<div class="chart-title"> <strong> Cliente </strong></div>
		</div>
	</div>
 	<div class="row" id="control-row">
    	<div class="col-xs-2 pie-chart">
      		<h4>Año (#)<small><a id="year">limpiar</a></small></h4>
      		<div class="dc-chart" id="chart-year"></div>
		</div>
    	<div class="col-xs-2 pie-chart">
      		<h4>Trimestre (#)<small><a id="quarter">limpiar</a></small></h4>
      		<div class="dc-chart" id="chart-quarter"></div>
		</div>
    	<div class="col-xs-2 pie-chart">
      		<h4>Mes (#)<small><a id="quarter">limpiar</a></small></h4>
      		<div class="dc-chart" id="chart-month"></div>
		</div>
    	<div class="col-xs-2 pie-chart">
      		<h4>Año ($)<small><a id="year-money">limpiar</a></small></h4>
      		<div class="dc-chart" id="chart-year-money"></div>
		</div>
    	<div class="col-xs-2 pie-chart">
      		<h4>Trimestre ($)<small><a id="quarter-money">limpiar</a></small></h4>
      		<div class="dc-chart" id="chart-quarter-money"></div>
		</div>
    	<div class="col-xs-2 pie-chart">
      		<h4>Mes ($)<small><a id="quarter-money">limpiar</a></small></h4>
      		<div class="dc-chart" id="chart-month-money"></div>
		</div>
    </div>
	<div class="row" id="customer-row">
		<div class="col-xs-12">
      		<h4>Propuestas x cliente (#)<small>[<a id="customer-count">limpiar</a>] [<a onclick ="document.getElementById('barchart-customer-count').style.display = 'none'">ocultar</a>] [<a onclick ="document.getElementById('barchart-customer-count').style.display = 'inline'">mostrar</a>]</small></h4>
			<div class="dc-chart" id="barchart-customer-count"></div>
		</div>
    </div>
	<div class="row" id="customer-row">
		<div class="col-xs-6">
      		<h4>Propuestas x estado (#)<small> [<a id="stage-count">limpiar</a>] [<a onclick ="document.getElementById('barchart-stage-count').style.display = 'none'">ocultar</a>] [<a onclick ="document.getElementById('barchart-stage-count').style.display = 'inline'">mostrar</a>]</small></h4>
			<div class="dc-chart" id="barchart-stage-count"></div>
		</div>
		<div class="col-xs-6">
      		<h4>Propuestas x encargado (#)<small> [<a id="person-count">limpiar</a>] [<a onclick ="document.getElementById('barchart-person-count').style.display = 'none'">ocultar</a>] [<a onclick ="document.getElementById('barchart-person-count').style.display = 'inline'">mostrar</a>]</small></h4>
			<div class="dc-chart" id="barchart-person-count"></div>
		</div>
	</div>
	<div class="row" id="customer-row">
		<div class="col-xs-12">
      		<h4>Propuestas x cliente ($)<small>[<a id="customer-count-money">limpiar</a>] [<a onclick ="document.getElementById('barchart-customer-count-money').style.display = 'none'">ocultar</a>] [<a onclick ="document.getElementById('barchart-customer-count-money').style.display = 'inline'">mostrar</a>]</small></h4>
			<div class="dc-chart" id="barchart-customer-count-money"></div>
		</div>
    </div>
	<div class="row" id="customer-row">
		<div class="col-xs-6">
      		<h4>Propuestas x estado ($)<small> [<a id="stage-count-money">limpiar</a>] [<a onclick ="document.getElementById('barchart-stage-count-money').style.display = 'none'">ocultar</a>] [<a onclick ="document.getElementById('barchart-stage-count-money').style.display = 'inline'">mostrar</a>]</small></h4>
			<div class="dc-chart" id="barchart-stage-count-money"></div>
		</div>
		<div class="col-xs-6">
      		<h4>Propuestas x encargado ($)<small> [<a id="person-count-money">limpiar</a>] [<a onclick ="document.getElementById('barchart-person-count-money').style.display = 'none'">ocultar</a>] [<a onclick ="document.getElementById('barchart-person-count-money').style.display = 'inline'">mostrar</a>]</small></h4>
			<div class="dc-chart" id="barchart-person-count-money"></div>
		</div>
	</div>
	<div class="row">
		<div class="col-xs-12">
			<table class="table table-bordered table-striped" id="data-table">
			<thead>
				<tr class="header">	
					<th>Cliente</th>
					<th>Encargado</th>
					<th>Estado</th>
					<th>Cierre</th>
					<th>Monto</th>
					<th>Descripción</th>
					<th>Detalles</th>
				</tr>
			</thead>
			</table>
		</div>
	</div>
</div>
<script type="text/javascript" src="js/d3.js"></script>
<script type="text/javascript" src="js/crossfilter.js"></script>
<script type="text/javascript" src="js/dc.js"></script>
<script type="text/javascript" src="js/underscore-min.js"></script>
<script type="text/javascript">

d3.json('opportunities.json', function(error,data) {
	if(error) { 
		console.log('There is an error '+ error);
		return;
	}
	var oppData = data.entry_list;
	var ndx = crossfilter(oppData);
/**
 * Dimensions 
 */
	var yearDim = ndx.dimension(function(d) {return +d.name_value_list.date_closed.value.substring(0,4);});
	var quarterDim = ndx.dimension(function (d) { var month = d.name_value_list.date_closed.value.substring(5,7); return 1+Math.floor((month-1)/3);});
	var monthDim = ndx.dimension(function (d) { return +d.name_value_list.date_closed.value.substring(5,7);});
	var customerDim = ndx.dimension(function (d) { return  d.name_value_list.account_name.value; });
	var stageDim = ndx.dimension(function (d) { return d.name_value_list.sales_stage.value; });
	var personDim = ndx.dimension(function (d) { return d.name_value_list.modified_by_name.value;});
	var moneyDim = ndx.dimension(getMoney);
	var allDim = ndx.dimension(function(d) {return d;});
	var all = ndx.groupAll();
/**
 * Groups
 */
	var countPerYear = yearDim.group().reduceCount();
	var countPerQuarter = quarterDim.group().reduceCount();
	var countPerMonth = monthDim.group().reduceCount();
	var countPerCustomer = customerDim.group().reduceCount();
	var countPerStage  = stageDim.group().reduceCount();
	var countPerPerson = personDim.group().reduceCount();
	
	var moneyPerYear = yearDim.group().reduceSum(getMoney);
	var moneyPerQuarter = quarterDim.group().reduceSum(getMoney);
	var moneyPerMonth = monthDim.group().reduceSum(getMoney);
	var moneyPerCustomer = customerDim.group().reduceSum(getMoney);
	var moneyPerStage  = stageDim.group().reduceSum(getMoney);
	var moneyPerPerson = personDim.group().reduceSum(getMoney);

/**
 * Filters
 */
	yearFilter = dc.selectMenu("#filter-year").dimension(yearDim).group(countPerYear);
	monthFilter= dc.selectMenu("#filter-month").dimension(monthDim).group(countPerMonth);
	quarterFilter= dc.selectMenu("#filter-quarter").dimension(quarterDim).group(countPerQuarter);
	customerFilter= dc.selectMenu("#filter-customer").dimension(customerDim).group(countPerCustomer);
	stageFilter = dc.selectMenu("#filter-stage").dimension(stageDim).group(countPerStage);
	personFilter = dc.selectMenu("#filter-person").dimension(personDim).group(countPerPerson);

/**
 *  Charts and tables
 */
	yearChart = dc.pieChart("#chart-year");
	quarterChart = dc.pieChart("#chart-quarter");
	monthChart = dc.pieChart("#chart-month");
	customerCountBarchart = dc.rowChart("#barchart-customer-count");
	stageCountBarchart = dc.rowChart("#barchart-stage-count");
	personCountBarchart = dc.rowChart("#barchart-person-count");
	
	yearChartMoney = dc.pieChart("#chart-year-money");
	quarterChartMoney = dc.pieChart("#chart-quarter-money");
	monthChartMoney = dc.pieChart("#chart-month-money");
	customerCountBarchartMoney = dc.rowChart("#barchart-customer-count-money");
	stageCountBarchartMoney = dc.rowChart("#barchart-stage-count-money");
	personCountBarchartMoney = dc.rowChart("#barchart-person-count-money");

    dataTable = dc.dataTable('#data-table');
    dataCount = dc.dataCount('#data-count');
/**
 * Chart and tables config
 */	
 	yearChart.width(150).height(150).dimension(yearDim).group(countPerYear).innerRadius(20);
	quarterChart.width(150).height(150).dimension(quarterDim).group(countPerQuarter);
	monthChart.width(150).height(150).dimension(monthDim).group(countPerMonth);
 	
	yearChartMoney.width(150).height(150).dimension(yearDim).group(moneyPerYear).innerRadius(20);
	quarterChartMoney.width(150).height(150).dimension(quarterDim).group(moneyPerQuarter);
	monthChartMoney.width(150).height(150).dimension(monthDim).group(moneyPerMonth);
  	
	customerCountBarchart.width(480).height(600)
		.dimension(customerDim)
		.group(countPerCustomer)
        .elasticX(true)
		
		;
	stageCountBarchart.width(400).height(600)
		.dimension(stageDim)
		.group(countPerStage)
        .elasticX(true)
		;

	customerCountBarchartMoney.width(480).height(600)
		.dimension(customerDim)
		.group(moneyPerCustomer)
        .elasticX(true)
		
		;
	stageCountBarchartMoney.width(400).height(600)
		.dimension(stageDim)
		.group(moneyPerStage)
        .elasticX(true)
		;

	personCountBarchart.width(400).height(600)
		.dimension(personDim)
		.group(countPerPerson)
        .elasticX(true)
		;
	
    personCountBarchartMoney.width(400).height(600)
		.dimension(personDim)
		.group(moneyPerPerson)
        .elasticX(true)
		;
	
  	dataCount
      .dimension(ndx)
      .group(all);
	
	dataTable
		.dimension(allDim)
		.group(function(d) { return 'Información de propuestas';})
		.size(100)
		.columns([
/*					Cliente
					Encargado
 					Estado
					Monto
					Descripción
*/
			function(d) { return d.name_value_list.account_name.value; },
			function(d) { return d.name_value_list.modified_by_name.value;},
			function(d) { return d.name_value_list.sales_stage.value; },
			function(d) { return d.name_value_list.date_closed.value;},
			function(d) { var money = +d.name_value_list.amount.value; 
				var currency = (d.name_value_list.currency_id.value.length>3)?"US$":"$";
				return currency + " " + money.toFixed(0).replace(/./g, function(c, i, a) {
        			return i > 0 && c !== "." && (a.length - i) % 3 === 0 ? "." + c : c;
    			});
			},
			function(d) { return "<b>"+ d.name_value_list.name.value + "</b> "; },
			function(d) { return "<a href=\"http://crm.ingenian.com/index.php?module=Opportunities&action=DetailView&record="+d.id+"\">Detalles</a>"; }
		])

  	d3.selectAll('a#all').on('click', function () {
    	dc.filterAll();
	    dc.renderAll();
  	});
	d3.selectAll('a#year').on('click', function () {
    	yearChart.filterAll();
	    dc.redrawAll();
  	});

	d3.selectAll('a#quarter').on('click', function () {
    	quarterChart.filterAll();
	    dc.redrawAll();
  	});
	d3.selectAll('a#month').on('click', function () {
    	monthChart.filterAll();
	    dc.redrawAll();
  	});
	d3.selectAll('a#customer-count').on('click', function () {
    	customerCountBarchart.filterAll();
	    dc.redrawAll();
  	});
	d3.selectAll('a#stage-count').on('click', function () {
    	stageCountBarchart.filterAll();
	    dc.redrawAll();
  	});
	d3.selectAll('a#person-count').on('click', function () {
    	personCountBarchart.filterAll();
	    dc.redrawAll();
  	});
	dc.renderAll();
});
function getMoney(record) {
		if(record.name_value_list) {
			var money = +record.name_value_list.amount.value; 
			var currency = (record.name_value_list.currency_id.value.length>3)?3000:1;
			return money*currency/1000000;
		}
}
</script>
</body>
</html>
